name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - master
  

jobs:
  windows-release:
    name: Windows Release
    runs-on: windows-2022
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          # Grab all the git history for building changelog
          fetch-depth: 0
      
      - name: Setup Node.js environment
        uses: actions/setup-node@v3.1.1
        with:
          node-version: 16.14.x
          cache: npm
      
      - name: NPM Install
        run: npm install
      
      - name: Set Version Environment Variable
        run: 'echo "VERSION=$(node -pe "require('./package.json').version") >> $GITHUB_ENV'

      - name: Create Release Pull Request
        id: changesets
        uses: changesets/action@v1
        with:
          commit: version for release
          title: Version and Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build with Electron Builder
        # If the current push to master has no changesets then it is the merged PR for versioning and releasing
        # TODO: This assumes that there are not commits to master without changesets--fix this
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: npm run build

      - name: Create Release
        uses: ncipollo/release-action@v1.10.0
        if: steps.changesets.outputs.hasChangesets == 'false'
        with:
          tag: ${{ env.VERSION }}
          commit: main
          artifacts: "releases/**/*.exe, releases/**/*.exe.blockmap, releases/**/latest.yml"
          bodyFile: "CHANGELOG.md"
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: true



        
